# Flask Bonus System

Flask-приложение для управления уровнями бонусной программы пользователей.

## Функционал

1. **Аутентификация**: Пользователи могут зарегистрироваться и войти в систему с помощью логина и пароля. После успешной авторизации выдается JWT-токен.
2. **Уровни бонусов**: Система поддерживает уровни бонусной программы, которые автоматически обновляются на основе трат пользователя.
3. **Транзакции**: Пользователь может добавлять транзакции, что инициирует проверку уровня бонусов.

---

## Настройка окружения

### 1. Переменные окружения

Создайте файл `.env` в корне проекта со следующим содержимым:

```
DATABASE_URL=
TESTING=
SECRET_KEY=
```

### 2. Миграции базы данных
	
```
Применение миграций из папки migrations:

```bash
goose postgres "postgresql://postgres:password@localhost:5432/postgres?sslmode=disable" up
```

---

## Маршруты API

### Аутентификация

#### 1. Регистрация пользователя

**POST** `/auth/register`

- **Описание**: Регистрирует нового пользователя с уровнем бонуса "Bronze" по умолчанию.
- **Пример запроса**:
    
    ```json
    {
      "username": "newuser",
      "password": "securepassword"
    }
    ```
    
- **Пример ответа**:
    
    ```json
    {
      "token": "your_jwt_token_here",
      "user_id": 1
    }
    ```
    

#### 2. Логин пользователя

**POST** `/auth/login`

- **Описание**: Аутентифицирует пользователя и выдает JWT-токен.
- **Пример запроса**:
    
    ```json
    {
      "username": "newuser",
      "password": "securepassword"
    }
    ```
    
- **Пример ответа**:
    
    ```json
    {
      "token": "your_jwt_token_here"
    }
    ```
    

### Уровни бонусов

#### 3. Получение текущего бонусного уровня

**GET** `/users/{id}/bonus`

- **Описание**: Возвращает информацию о текущем уровне бонусной программы для указанного пользователя.
- **Требует**: JWT-токен.
- **Пример ответа**:
    
    ```json
    {
      "id": 1,
      "name": "Bronze",
      "min_spendings": 0,
      "cashback_percentage": 5
    }
    ```
    

### Транзакции

#### 4. Добавление новой транзакции

**POST** `/users/{id}/transactions`

- **Описание**: Добавляет новую транзакцию и проверяет, нужно ли обновить уровень бонусов.
- **Требует**: JWT-токен.
- **Пример запроса**:
    
    ```json
    {
      "amount": 600
    }
    ```
    
- **Пример ответа**:
    
    ```json
    {
      "transaction_id": 5,
      "amount": 600,
      "new_spendings": 600,
      "bonus_update": "Bonus level updated"
    }
    ```
    

---

## Запуск приложения через Docker

### 1. Сборка Docker-образа

```bash
docker-compose build
```

### 2. Запуск контейнеров

```bash
docker-compose up
```

Приложение будет доступно по адресу [http://localhost:5000](http://localhost:5000/).

### 3. Остановка контейнеров

```bash
docker-compose down
```

---

## Запуск тестов

```bash
pytest tests/
```

